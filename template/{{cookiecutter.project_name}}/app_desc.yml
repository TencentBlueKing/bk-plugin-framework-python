specVersion: 3
modules:
  - name: default
    isDefault: true
    language: python
    spec:
      hooks:
        preRelease:
          procCommand: "bash bin/sync_apigateway.sh"
      processes:
        - name: web
          procCommand: gunicorn bk_plugin_runtime.wsgi --timeout 120 -k gthread --threads 16 -w 8 --max-requests=1000 --env prometheus_multiproc_dir=/tmp/
          services:
            - name: web
              exposedType:
                name: bk/http
              targetPort: 5000
              port: 80
        - name: schedule
          procCommand: celery worker -A blueapps.core.celery -P threads -n schedule_worker@%h -c 500 -Q plugin_schedule,plugin_callback,schedule_delete -l INFO
        - name: beat
          procCommand: celery beat -A blueapps.core.celery -l INFO
        - name: c-monitor
          procCommand: celery-prometheus-exporter --broker amqp://$RABBITMQ_USER:$RABBITMQ_PASSWORD@$RABBITMQ_HOST:$RABBITMQ_PORT/$RABBITMQ_VHOST --addr 0.0.0.0:5001 --queue-list plugin_schedule plugin_callback schedule_delete
      configuration:
        env:
          - name: PYTHONPATH
            value: /app
            description: 将项目根目录添加到Python路径，使Python能直接引用本地的bk_plugin_runtime和bk_plugin_framework
          - name: PIP_VERSION
            value: 21.2.2
            description: pip version control
          - name: BK_APIGW_MANAGER_URL_TMPL
            value: http://{api_name}.apigw.o.woa.com
            description: pip version control
          - name: BK_APIGW_MANAGER_MAINTAINERS
            value: simonyi
            description: plugin apigw managers
          - name: BK_INIT_SUPERUSER
            value: simonyi
            description: plugin admin panel init superuser
          - name: BK_SOPS_APP_CODE
            value: bksops
            description: bk-sops app code
          - name: DJANGO_SETTINGS_MODULE
            value: bk_plugin_runtime.settings
            description: django settings module path
          - name: BK_APP_CONFIG_PATH
            value: bk_plugin_runtime.config
            description: blueapps config path
          - name: BK_APIGW_CORS_ALLOW_ORIGINS
            value: ''
            description: apigw cors strategie allow origins
          - name: BK_APIGW_CORS_ALLOW_METHODS
            value: GET,POST,PUT,PATCH,HEAD,DELETE,OPTIONS
            description: apigw cors strategie allow methods
          - name: BK_APIGW_CORS_ALLOW_HEADERS
            value: Accept,Cache-Control,Content-Type,Keep-Alive,Origin,User-Agent,X-Requested-With
            description: apigw cors strategie allow headers
          - name: BK_APIGW_DEFAULT_TIMEOUT
            value: 60
            description: apigw default timeout
